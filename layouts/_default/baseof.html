<!DOCTYPE html>
<html lang="{{ .Site.Language.Lang | default "vi" }}">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>{{ .Title }} | Mobile Center</title>
    
    <link rel="stylesheet" href="{{ "/css/product-style.css" | relURL }}" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css" />
    
    {{ hugo.Generator }}

    <style>
        /* CSS Popup Ch√†o m·ª´ng */
        #user-info-modal .modal-content { text-align: center; max-width: 400px; }
        .promo-text { color: #d70018; font-weight: bold; font-size: 1.1rem; margin-bottom: 20px; }
        .voucher-box-dashed { border: 2px dashed #d70018; background-color: #fff0f0; padding: 15px; border-radius: 8px; margin-bottom: 20px; color: #d70018; font-weight: 700; }
        .input-group { text-align: left; margin-bottom: 15px; }
        .input-group label { display: block; font-weight: 600; margin-bottom: 5px; }
        .input-group input { width: 100%; padding: 10px; border: 1px solid #ccc; border-radius: 5px; font-size: 1rem; }
        #save-user-info { width: 100%; background: #007bff; color: white; padding: 12px; border: none; border-radius: 5px; font-weight: bold; cursor: pointer; margin-top: 10px; }
        
        /* CSS Modal Thanh To√°n */
        #global-checkout-modal .modal-content { width: 95%; max-width: 600px; padding: 30px; text-align: left; position: relative; }
        #global-checkout-modal h2 { border-bottom: none; padding-bottom: 0; margin-bottom: 20px; font-size: 1.5rem; font-weight: 700; }
        .address-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; }
        #global-bank-info { background: #f0f8ff; border: 1px dashed #007bff; padding: 15px; border-radius: 8px; margin-top: 10px; margin-bottom: 15px; }
        .btn-red-confirm { width: 100%; background: #d70018; color: white; padding: 15px; border: none; border-radius: 5px; font-weight: 700; font-size: 1.1rem; cursor: pointer; margin-top: 20px; }
    </style>
</head>
<body>

    <nav class="main-navbar">
        <div class="navbar-container">
            <a href="{{ "/" | relURL }}" class="navbar-brand">Mobile Center</a>
            <div class="navbar-links">
                <a href="{{ "/" | relURL }}" class="nav-link">Trang ch·ªß</a>
                <a href="{{ "/san-pham" | relURL }}" class="nav-link">S·∫£n ph·∫©m</a>
                <a href="#" class="nav-link" id="global-cart-button">
                    <i class="fas fa-shopping-cart"></i> Gi·ªè h√†ng
                    <span id="global-cart-badge" class="cart-badge hidden">0</span>
                </a>
            </div>
        </div>
    </nav>

    <main id="main-content">
        {{ block "main" . }}{{ end }}
    </main>

    <footer class="site-footer">
        <div class="footer-wrapper">
            <div class="footer-col">
                <h3>Mobile Center</h3>
                <p style="color: #ccc; line-height: 1.6;">
                    H·ªá th·ªëng b√°n l·∫ª ƒëi·ªán tho·∫°i ch√≠nh h√£ng uy t√≠n nh·∫•t. <br>
                    Cam k·∫øt ch·∫•t l∆∞·ª£ng, gi√° c·∫£ c·∫°nh tranh.
                </p>
            </div>

            <div class="footer-col">
                <h3>Th√¥ng tin li√™n h·ªá</h3>
                <div class="footer-info">
                    <p>
                        <i class="fas fa-phone-alt"></i> 
                        <a href="tel:0848921193">0848921193</a>
                    </p>
                    <p>
                        <i class="fas fa-envelope"></i> 
                        <a href="mailto:dbinh1312@gmail.com">dbinh1312@gmail.com</a>
                    </p>
                    <p>
                        <i class="fab fa-facebook-f"></i> 
                        <a href="https://www.facebook.com/ltdb.2910" target="_blank">L√™ Tr·ªãnh Duy B√¨nh</a>
                    </p>
                </div>
            </div>
        </div>
        
        <div class="copyright">
            &copy; 2025 Mobile Center. All rights reserved.
        </div>
    </footer>

    <div id="user-info-modal" class="modal-overlay hidden" data-locked="true">
        <div class="modal-content">
            <h2>Ch√†o m·ª´ng!</h2>
            <p class="promo-text">Cho ch√∫ng m√¨nh xin th√¥ng tin li√™n h·ªá nh√© !!!</p>
            <div class="voucher-box-dashed">üéâ T·∫∑ng voucher gi·∫£m gi√° khi b·∫°n l√† sinh vi√™n ƒêH KHTN !!! üéÜ</div>
            <div class="input-group"><label>T√™n c·ªßa b·∫°n <span style="color:red">*</span></label><input type="text" id="user-name-input"></div>
            <div class="input-group"><label>S·ªë ƒëi·ªán tho·∫°i <span style="color:red">*</span></label><input type="tel" id="user-phone-input"></div>
            <button id="save-user-info">L∆∞u th√¥ng tin</button>
        </div>
    </div>

    <div id="cart-modal" class="modal-overlay hidden">
        <div class="modal-content">
            <span class="close-modal" id="close-cart-btn-x">&times;</span>
            <h2 style="border-bottom:1px solid #eee; padding-bottom:10px;">Gi·ªè h√†ng c·ªßa b·∫°n</h2>
            <ul id="cart-item-list"></ul>
            <div class="cart-total">
                <strong>T·ªïng c·ªông:</strong>
                <strong id="cart-total-price" style="color:#d70018;">0ƒë</strong>
            </div>
            <div style="text-align:right; margin-top:10px;">
                <button id="clear-cart-button" style="background:none; border:none; color:red; text-decoration:underline; cursor:pointer;">X√≥a gi·ªè h√†ng</button>
            </div>
            <div class="cart-buttons">
                <button id="close-cart-modal" style="background:#eee;">Ti·∫øp t·ª•c mua</button>
                <button id="go-to-checkout" style="background:#007bff; color:white;">Thanh to√°n</button>
            </div>
        </div>
    </div>

    <div id="global-checkout-modal" class="modal-overlay hidden">
        <div class="modal-content">
            <span class="close-modal" id="close-checkout-global">&times;</span>
            
            <div id="global-checkout-form-wrapper">
                <h2>Th√¥ng tin thanh to√°n</h2>
                
                <div class="input-group">
                    <label>H·ªç v√† T√™n <span style="color:red">*</span></label>
                    <input type="text" id="bill-name">
                </div>
                <div class="input-group">
                    <label>S·ªë ƒëi·ªán tho·∫°i <span style="color:red">*</span></label>
                    <input type="text" id="bill-phone">
                </div>
                <div class="input-group">
                    <label>ƒê·ªãa ch·ªâ (S·ªë nh√†, T√™n ƒë∆∞·ªùng) <span style="color:red">*</span></label>
                    <input type="text" id="bill-address" placeholder="123 ƒê∆∞·ªùng ABC">
                </div>
                <div class="address-grid">
                    <div class="input-group"><label>Ph∆∞·ªùng/X√£ <span style="color:red">*</span></label><input type="text" id="bill-ward"></div>
                    <div class="input-group"><label>Qu·∫≠n/Huy·ªán <span style="color:red">*</span></label><input type="text" id="bill-district"></div>
                </div>
                <div class="input-group">
                    <label>T·ªânh/Th√†nh ph·ªë <span style="color:red">*</span></label>
                    <input type="text" id="bill-city" placeholder="TP. H·ªì Ch√≠ Minh">
                </div>

                <hr style="border:0; border-top:1px solid #eee; margin: 20px 0;">

                <div class="form-group">
                    <h3 style="font-size:1rem; margin-bottom:10px; font-weight:700;">Ph∆∞∆°ng th·ª©c thanh to√°n</h3>
                    <div class="payment-options">
                        <label><input type="radio" name="global-payment" value="cod" checked> Thanh to√°n khi nh·∫≠n h√†ng (COD)</label>
                        <label><input type="radio" name="global-payment" value="bank"> Chuy·ªÉn kho·∫£n ng√¢n h√†ng</label>
                    </div>
                </div>

                <div id="global-bank-info" class="hidden">
                    <h4>Th√¥ng tin chuy·ªÉn kho·∫£n</h4>
                    <ul>
                        <li>S·ªë ti·ªÅn: <strong id="bank-transfer-amount" style="color:#d70018; text-decoration:underline;"></strong></li>
                        <li>Ng√¢n h√†ng: <strong>MB Bank (Ng√¢n h√†ng Qu√¢n ƒë·ªôi)</strong></li>
                        <li>S·ªë t√†i kho·∫£n: <strong>0123456789</strong></li>
                        <li>Ch·ªß t√†i kho·∫£n: <strong>NGUYEN VAN A</strong></li>
                        <li>N·ªôi dung: <strong>[SƒêT c·ªßa b·∫°n]</strong></li>
                    </ul>
                </div>

                <div id="global-transaction-code" class="input-group hidden" style="margin-top:15px;">
                    <label>M√£ giao d·ªãch <span style="color:red">*</span></label>
                    <input type="text" id="bill-transaction-code" placeholder="Nh·∫≠p m√£ giao d·ªãch t·ª´ ng√¢n h√†ng c·ªßa b·∫°n">
                </div>

                <button id="btn-confirm-global" class="btn-red-confirm">X√°c nh·∫≠n ƒë·∫∑t h√†ng</button>
            </div>

            <div id="global-checkout-success" class="hidden" style="text-align: center; padding: 40px 0;">
                <h2 style="color: #28a745; font-size: 2rem; margin-bottom: 15px;">ƒê·∫∑t h√†ng th√†nh c√¥ng!</h2>
                <p style="font-size: 1.1rem; margin-bottom: 10px;">C·∫£m ∆°n b·∫°n ƒë√£ mua h√†ng</p>
                <p style="color: #666;">Ch√∫ng t√¥i s·∫Ω chuy·ªÉn h∆∞·ªõng sau 3 gi√¢y...</p>
            </div>
        </div>
    </div>

    <script>
      function formatCurrencyGlobal(value) {
        return new Intl.NumberFormat("vi-VN", { style: "currency", currency: "VND" }).format(value);
      }
      
      let globalCartItems = [];
      const cartModal = document.getElementById("cart-modal");
      const checkoutModal = document.getElementById("global-checkout-modal");
      const badge = document.getElementById("global-cart-badge");

      function updateBadge() {
        let total = 0;
        if(globalCartItems) total = globalCartItems.reduce((acc, item) => acc + item.quantity, 0);
        if (total > 0) {
          badge.textContent = total;
          badge.classList.remove("hidden");
        } else {
          badge.classList.add("hidden");
        }
      }

      function loadCart() {
        globalCartItems = JSON.parse(sessionStorage.getItem("shoppingCart")) || [];
        updateBadge();
      }

      function renderCart() {
        const list = document.getElementById("cart-item-list");
        const totalEl = document.getElementById("cart-total-price");
        list.innerHTML = "";
        let total = 0;
        if (globalCartItems.length === 0) {
          list.innerHTML = "<li style='text-align:center; padding:20px;'>Gi·ªè h√†ng tr·ªëng.</li>";
          totalEl.textContent = formatCurrencyGlobal(0);
          return;
        }
        globalCartItems.forEach((item, index) => {
          total += item.price * item.quantity;
          list.innerHTML += `
            <li style="display:flex; justify-content:space-between; padding:10px 0; border-bottom:1px solid #eee;">
              <div>
                <strong>${item.name}</strong> <br>
                <small>${item.variant} - ${item.color} (x${item.quantity})</small>
              </div>
              <div style="text-align:right;">
                  <div style="color:#d70018; font-weight:bold;">${formatCurrencyGlobal(item.price * item.quantity)}</div>
                  <span style="color:red; cursor:pointer; font-size:0.8rem;" onclick="removeCartItem(${index})">X√≥a</span>
              </div>
            </li>`;
        });
        totalEl.textContent = formatCurrencyGlobal(total);
      }
      
      window.removeCartItem = function(index) {
          globalCartItems.splice(index, 1);
          sessionStorage.setItem("shoppingCart", JSON.stringify(globalCartItems));
          renderCart();
          updateBadge();
      }

      function checkUserPopup() {
          const userInfo = sessionStorage.getItem("userInfo");
          const userModal = document.getElementById("user-info-modal");
          // N·∫øu ch∆∞a c√≥ th√¥ng tin -> Hi·ªán popup
          if (!userInfo) {
              setTimeout(() => { userModal.classList.remove("hidden"); }, 500);
          }
      }

      document.addEventListener("DOMContentLoaded", function () {
        loadCart();
        checkUserPopup();

        // --- 1. L∆ØU TH√îNG TIN T·ª™ POPUP ---
        document.getElementById("save-user-info").addEventListener("click", function() {
            const name = document.getElementById("user-name-input").value.trim();
            const phone = document.getElementById("user-phone-input").value.trim();
            
            if(name && phone) {
                const info = { name: name, phone: phone };
                sessionStorage.setItem("userInfo", JSON.stringify(info));
                alert("Ch√†o m·ª´ng " + name + "!");
                document.getElementById("user-info-modal").classList.add("hidden");
            } else {
                alert("Vui l√≤ng ƒëi·ªÅn ƒë·∫ßy ƒë·ªß th√¥ng tin!");
            }
        });

        // Ch·∫∑n t·∫Øt popup
        const userModal = document.getElementById("user-info-modal");
        userModal.addEventListener("click", function(e) { if (e.target === userModal) { e.stopPropagation(); } });

        // --- 2. GI·ªé H√ÄNG ---
        document.getElementById("global-cart-button").addEventListener("click", function(e) {
            e.preventDefault();
            renderCart();
            cartModal.classList.remove("hidden");
        });
        
        const closeCart = () => cartModal.classList.add("hidden");
        document.getElementById("close-cart-btn-x").addEventListener("click", closeCart);
        document.getElementById("close-cart-modal").addEventListener("click", closeCart);
        cartModal.addEventListener("click", (e) => { if(e.target === cartModal) closeCart(); });

        document.getElementById("clear-cart-button").addEventListener("click", function() {
            if(confirm("X√≥a h·∫øt gi·ªè h√†ng?")) {
                globalCartItems = [];
                sessionStorage.setItem("shoppingCart", JSON.stringify(globalCartItems));
                renderCart();
                updateBadge();
            }
        });

        // --- 3. M·ªû THANH TO√ÅN (T·ª∞ ƒêI·ªÄN TH√îNG TIN ƒê√É L∆ØU) ---
        function openCheckout() {
            if(globalCartItems.length === 0) { alert("Gi·ªè h√†ng tr·ªëng!"); return; }
            cartModal.classList.add("hidden");
            
            // === ƒê√ÇY L√Ä ƒêO·∫†N QUAN TR·ªåNG: L·∫§Y T√äN T·ª™ SESSION ƒêI·ªÄN V√ÄO FORM ===
            const userInfo = JSON.parse(sessionStorage.getItem("userInfo"));
            if(userInfo) {
                document.getElementById("bill-name").value = userInfo.name || "";
                document.getElementById("bill-phone").value = userInfo.phone || "";
            }
            // =================================================================

            let total = globalCartItems.reduce((acc, item) => acc + item.price * item.quantity, 0);
            document.getElementById("bank-transfer-amount").innerText = formatCurrencyGlobal(total);

            document.getElementById("global-checkout-form-wrapper").classList.remove("hidden");
            document.getElementById("global-checkout-success").classList.add("hidden");
            checkoutModal.classList.remove("hidden");
        }

        document.getElementById("go-to-checkout").addEventListener("click", openCheckout);
        document.getElementById("close-checkout-global").addEventListener("click", () => checkoutModal.classList.add("hidden"));

        // Chuy·ªÉn ƒë·ªïi thanh to√°n
        const payRadios = document.querySelectorAll('input[name="global-payment"]');
        const bankInfo = document.getElementById("global-bank-info");
        const transCode = document.getElementById("global-transaction-code");
        const btnConfirm = document.getElementById("btn-confirm-global");

        payRadios.forEach(r => r.addEventListener('change', function() {
            if(this.value === 'bank') {
                bankInfo.classList.remove("hidden");
                transCode.classList.remove("hidden");
                btnConfirm.textContent = "X√°c nh·∫≠n ƒë√£ chuy·ªÉn ti·ªÅn";
            } else {
                bankInfo.classList.add("hidden");
                transCode.classList.add("hidden");
                btnConfirm.textContent = "X√°c nh·∫≠n ƒë·∫∑t h√†ng";
            }
        }));

        // --- 4. X√ÅC NH·∫¨N ƒê·∫∂T H√ÄNG (VALIDATION CH·∫∂T CH·∫º) ---
        document.getElementById("btn-confirm-global").addEventListener("click", function() {
            const name = document.getElementById("bill-name").value.trim();
            const phone = document.getElementById("bill-phone").value.trim();
            const address = document.getElementById("bill-address").value.trim();
            const ward = document.getElementById("bill-ward").value.trim();
            const district = document.getElementById("bill-district").value.trim();
            const city = document.getElementById("bill-city").value.trim();
            
            if(!name || !phone || !address || !ward || !district || !city) {
                alert("‚ùå Vui l√≤ng ƒëi·ªÅn ƒë·∫ßy ƒë·ªß th√¥ng tin giao h√†ng!");
                return;
            }

            const paymentMethod = document.querySelector('input[name="global-payment"]:checked').value;
            if(paymentMethod === 'bank') {
                const code = document.getElementById("bill-transaction-code").value.trim();
                if(!code) {
                    alert("‚ùå Vui l√≤ng nh·∫≠p M√£ giao d·ªãch chuy·ªÉn kho·∫£n!");
                    return;
                }
            }

            let orders = JSON.parse(sessionStorage.getItem("allOrders")) || [];
            let total = globalCartItems.reduce((acc, item) => acc + item.price * item.quantity, 0);
            
            orders.push({
                id: Date.now(),
                customer: { name, phone, address: `${address}, ${ward}, ${district}, ${city}` },
                items: globalCartItems,
                total: total,
                date: new Date().toLocaleString()
            });
            sessionStorage.setItem("allOrders", JSON.stringify(orders));

            globalCartItems = [];
            sessionStorage.setItem("shoppingCart", JSON.stringify(globalCartItems));
            updateBadge();

            document.getElementById("global-checkout-form-wrapper").classList.add("hidden");
            document.getElementById("global-checkout-success").classList.remove("hidden");

            setTimeout(() => {
                window.location.href = "/don-hang/";
            }, 3000);
        });
      });
      
      // H√†m Mua Ngay (G·ªçi t·ª´ Single Page)
      window.buyNow = function(item) {
          globalCartItems.push(item);
          sessionStorage.setItem("shoppingCart", JSON.stringify(globalCartItems));
          updateBadge();
          
          // M·ªü thanh to√°n ngay -> JS s·∫Ω t·ª± ƒëi·ªÅn t√™n
          document.getElementById("go-to-checkout").click();
      };

      // H√†m Th√™m Gi·ªè (G·ªçi t·ª´ Single Page)
      window.addToCartLocal = function(item) {
          loadCart();
          const existing = globalCartItems.find(i => i.name === item.name && i.variant === item.variant && i.color === item.color);
          if(existing) existing.quantity += item.quantity;
          else globalCartItems.push(item);
          sessionStorage.setItem("shoppingCart", JSON.stringify(globalCartItems));
          updateBadge();
          renderCart();
          cartModal.classList.remove("hidden");
      };
    </script>
</body>
</html>