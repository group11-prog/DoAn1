<!DOCTYPE html>
<html lang="{{ .Site.Language.Lang | default "vi" }}">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>{{ .Title }} | Mobile Center</title>
    
    <link rel="stylesheet" href="{{ "/css/product-style.css" | relURL }}" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css" />
    
    {{ hugo.Generator }}

    <style>
        /* CSS POPUP CH√ÄO M·ª™NG (CHU·∫®N M·∫™U 100%) */
        #user-info-modal .modal-content { 
            text-align: center; 
            max-width: 420px; /* R·ªông h∆°n ch√∫t cho tho√°ng */
            padding: 30px;
            border-radius: 12px;
        }
        
        #user-info-modal h2 { 
            font-size: 2.2rem; 
            font-weight: 800; 
            margin-bottom: 10px; 
            color: #333;
            border: none; /* B·ªè g·∫°ch ch√¢n n·∫øu c√≥ */
        }
        
        .promo-text { 
            color: #d70018; 
            font-weight: 700; 
            font-size: 1.15rem; 
            margin-bottom: 20px; 
        }
        
        /* Khung Voucher n√©t ƒë·ª©t h·ªìng */
        .voucher-box-dashed { 
            border: 2px dashed #d70018; 
            background-color: #fff5f5; /* N·ªÅn h·ªìng nh·∫°t */
            padding: 15px; 
            border-radius: 8px; 
            margin-bottom: 25px; 
            color: #d70018; 
            font-weight: 700;
            font-size: 0.95rem;
            line-height: 1.5;
        }
        
        /* √î nh·∫≠p li·ªáu */
        .input-group { text-align: left; margin-bottom: 15px; }
        .input-group label { 
            display: block; 
            font-weight: 600; 
            margin-bottom: 8px; 
            color: #333;
        }
        .input-group input { 
            width: 100%; 
            padding: 12px; 
            border: 1px solid #ddd; 
            border-radius: 6px; 
            font-size: 1rem; 
            color: #333;
        }
        .input-group input::placeholder { color: #aaa; } /* Placeholder m·ªù */
        
        /* N√∫t L∆∞u th√¥ng tin */
        #save-user-info { 
            width: 100%; 
            background: #007bff; /* Xanh d∆∞∆°ng chu·∫©n */
            color: white; 
            padding: 12px; 
            border: none; 
            border-radius: 6px; 
            font-weight: 700; 
            font-size: 1rem; 
            cursor: pointer; 
            margin-top: 15px; 
            transition: background 0.2s;
        }
        #save-user-info:hover { background: #0056b3; }
        
        /* CSS Modal Thanh To√°n & Gi·ªè H√†ng (Gi·ªØ nguy√™n) */
        #global-checkout-modal .modal-content { width: 95%; max-width: 600px; padding: 30px; text-align: left; position: relative; }
        .btn-red-confirm { width: 100%; background: #d70018; color: white; padding: 15px; border: none; border-radius: 5px; font-weight: 700; font-size: 1.1rem; cursor: pointer; margin-top: 20px; }
    </style>
</head>
<body>

    <nav class="main-navbar">
        <div class="navbar-container">
            <a href="{{ "/" | relURL }}" class="navbar-brand">Mobile Center</a>
            <div class="navbar-links">
                <a href="{{ "/" | relURL }}" class="nav-link">Trang ch·ªß</a>
                <a href="{{ "/san-pham" | relURL }}" class="nav-link">S·∫£n ph·∫©m</a>
                <a href="#" class="nav-link" id="global-cart-button">
                    <i class="fas fa-shopping-cart"></i> Gi·ªè h√†ng
                    <span id="global-cart-badge" class="cart-badge hidden">0</span>
                </a>
            </div>
        </div>
    </nav>

    <main id="main-content">
        {{ block "main" . }}{{ end }}
    </main>

    <footer class="site-footer">
        <div class="footer-wrapper">
            <div class="footer-col">
                <h3>Mobile Center</h3>
                <p style="color:#ccc;">H·ªá th·ªëng b√°n l·∫ª ƒëi·ªán tho·∫°i ch√≠nh h√£ng uy t√≠n nh·∫•t.</p>
            </div>
            <div class="footer-col">
                <h3>Li√™n h·ªá</h3>
                <div class="footer-info">
                    <p><i class="fas fa-phone-alt"></i> 0848921193</p>
                    <p><i class="fab fa-facebook-f"></i> L√™ Tr·ªãnh Duy B√¨nh</p>
                </div>
            </div>
        </div>
        <div class="copyright">&copy; 2025 Mobile Center. All rights reserved.</div>
    </footer>

    <div id="user-info-modal" class="modal-overlay hidden" data-locked="true">
        <div class="modal-content">
            <h2>Ch√†o m·ª´ng!</h2>
            
            <p class="promo-text">Cho ch√∫ng m√¨nh xin th√¥ng tin li√™n h·ªá nh√© !!!</p>
            
            <div class="voucher-box-dashed">
                üéâ T·∫∑ng voucher gi·∫£m gi√° khi b·∫°n l√† sinh vi√™n ƒêH KHTN !!! üéÜ
            </div>
            
            <div class="input-group">
                <label>T√™n c·ªßa b·∫°n <span style="color:red">*</span></label>
                <input type="text" id="user-name-input" placeholder="Nguy·ªÖn VƒÉn A">
            </div>
            
            <div class="input-group">
                <label>S·ªë ƒëi·ªán tho·∫°i <span style="color:red">*</span></label>
                <input type="tel" id="user-phone-input" placeholder="09xxxxxxxx">
            </div>
            
            <button id="save-user-info">L∆∞u th√¥ng tin</button>
        </div>
    </div>

    <div id="cart-modal" class="modal-overlay hidden">
        <div class="modal-content">
            <span class="close-modal" id="close-cart-btn-x">&times;</span>
            <h2 style="border-bottom:1px solid #eee; padding-bottom:10px;">Gi·ªè h√†ng c·ªßa b·∫°n</h2>
            <ul id="cart-item-list"></ul>
            <div class="cart-total">
                <strong>T·ªïng c·ªông:</strong>
                <strong id="cart-total-price" style="color:#d70018;">0ƒë</strong>
            </div>
            <div style="text-align:right; margin-top:10px;">
                <button id="clear-cart-button" style="background:none; border:none; color:red; text-decoration:underline; cursor:pointer;">X√≥a gi·ªè h√†ng</button>
            </div>
            <div class="cart-buttons">
                <button id="close-cart-modal" style="background:#eee;">Ti·∫øp t·ª•c mua</button>
                <button id="go-to-checkout" style="background:#007bff; color:white;">Thanh to√°n</button>
            </div>
        </div>
    </div>

    <div id="global-checkout-modal" class="modal-overlay hidden">
        <div class="modal-content">
            <span class="close-modal" id="close-checkout-global">&times;</span>
            
            <div id="global-checkout-form-wrapper">
                <h2>Th√¥ng tin thanh to√°n</h2>
                
                <div class="input-group">
                    <label>H·ªç v√† T√™n <span style="color:red">*</span></label>
                    <input type="text" id="bill-name" placeholder="Nguy·ªÖn VƒÉn A">
                </div>
                <div class="input-group">
                    <label>S·ªë ƒëi·ªán tho·∫°i <span style="color:red">*</span></label>
                    <input type="text" id="bill-phone" placeholder="09xxxxxxxx">
                </div>
                <div class="input-group">
                    <label>ƒê·ªãa ch·ªâ (S·ªë nh√†, T√™n ƒë∆∞·ªùng) <span style="color:red">*</span></label>
                    <input type="text" id="bill-address" placeholder="123 ƒê∆∞·ªùng ABC">
                </div>
                
                <div class="address-grid">
                    <div class="input-group"><label>Ph∆∞·ªùng/X√£ <span style="color:red">*</span></label><input type="text" id="bill-ward" placeholder="Ph∆∞·ªùng 1"></div>
                    <div class="input-group"><label>Qu·∫≠n/Huy·ªán <span style="color:red">*</span></label><input type="text" id="bill-district" placeholder="Qu·∫≠n 1"></div>
                </div>
                <div class="input-group"><label>T·ªânh/Th√†nh ph·ªë <span style="color:red">*</span></label><input type="text" id="bill-city" placeholder="TP. H·ªì Ch√≠ Minh"></div>

                <hr style="margin: 20px 0; border:0; border-top:1px solid #eee;">

                <div class="form-group">
                    <h3 style="font-size:1rem; margin-bottom:10px; font-weight:700;">Ph∆∞∆°ng th·ª©c thanh to√°n</h3>
                    <div class="payment-options">
                        <label><input type="radio" name="global-payment" value="cod" checked> Thanh to√°n khi nh·∫≠n h√†ng (COD)</label>
                        <label><input type="radio" name="global-payment" value="bank"> Chuy·ªÉn kho·∫£n ng√¢n h√†ng</label>
                    </div>
                </div>

                <div id="global-bank-info" class="hidden">
                    <h4>Th√¥ng tin chuy·ªÉn kho·∫£n</h4>
                    <ul>
                        <li>S·ªë ti·ªÅn: <strong id="bank-transfer-amount" style="color:#d70018;"></strong></li>
                        <li>Ng√¢n h√†ng: <strong>MB Bank (Ng√¢n h√†ng Qu√¢n ƒë·ªôi)</strong></li>
                        <li>STK: <strong>0123456789</strong></li>
                        <li>Ch·ªß TK: <strong>NGUYEN VAN A</strong></li>
                        <li>N·ªôi dung: <strong>[SƒêT c·ªßa b·∫°n]</strong></li>
                    </ul>
                </div>

                <div id="global-transaction-code" class="input-group hidden" style="margin-top:15px;">
                    <label>M√£ giao d·ªãch <span style="color:red">*</span></label>
                    <input type="text" id="bill-transaction-code" placeholder="Nh·∫≠p m√£ giao d·ªãch">
                </div>

                <button id="btn-confirm-global" class="btn-red-confirm">X√°c nh·∫≠n ƒë·∫∑t h√†ng</button>
            </div>

            <div id="global-checkout-success" class="hidden" style="text-align: center; padding: 40px 0;">
                <h2 style="color: #28a745; font-size: 2rem; margin-bottom: 15px;">ƒê·∫∑t h√†ng th√†nh c√¥ng!</h2>
                <p style="font-size: 1.1rem; margin-bottom: 10px;">C·∫£m ∆°n b·∫°n ƒë√£ mua h√†ng</p>
                <p style="color: #666;">Ch√∫ng t√¥i s·∫Ω chuy·ªÉn h∆∞·ªõng sau 3 gi√¢y...</p>
            </div>
        </div>
    </div>

    <script>
      function formatCurrencyGlobal(value) {
        return new Intl.NumberFormat("vi-VN", { style: "currency", currency: "VND" }).format(value);
      }
      
      let globalCartItems = [];
      const cartModal = document.getElementById("cart-modal");
      const checkoutModal = document.getElementById("global-checkout-modal");
      const badge = document.getElementById("global-cart-badge");

      function updateBadge() {
        let total = 0;
        if(globalCartItems) total = globalCartItems.reduce((acc, item) => acc + item.quantity, 0);
        if (total > 0) {
          badge.textContent = total;
          badge.classList.remove("hidden");
        } else {
          badge.classList.add("hidden");
        }
      }

      function loadCart() {
        globalCartItems = JSON.parse(sessionStorage.getItem("shoppingCart")) || [];
        updateBadge();
      }

      function renderCart() {
        const list = document.getElementById("cart-item-list");
        const totalEl = document.getElementById("cart-total-price");
        list.innerHTML = "";
        let total = 0;
        if (globalCartItems.length === 0) {
          list.innerHTML = "<li style='text-align:center; padding:20px;'>Gi·ªè h√†ng tr·ªëng.</li>";
          totalEl.textContent = formatCurrencyGlobal(0);
          return;
        }
        globalCartItems.forEach((item, index) => {
          total += item.price * item.quantity;
          list.innerHTML += `
            <li style="display:flex; justify-content:space-between; padding:10px 0; border-bottom:1px solid #eee;">
              <div><strong>${item.name}</strong><br><small>${item.variant} - ${item.color} (x${item.quantity})</small></div>
              <div style="text-align:right;">
                  <div style="color:#d70018; font-weight:bold;">${formatCurrencyGlobal(item.price * item.quantity)}</div>
                  <span style="color:red; cursor:pointer; font-size:0.8rem;" onclick="removeCartItem(${index})">X√≥a</span>
              </div>
            </li>`;
        });
        totalEl.textContent = formatCurrencyGlobal(total);
      }
      
      window.removeCartItem = function(index) {
          globalCartItems.splice(index, 1);
          sessionStorage.setItem("shoppingCart", JSON.stringify(globalCartItems));
          renderCart();
          updateBadge();
      }

      function checkUserPopup() {
          const userInfo = sessionStorage.getItem("userInfo");
          const userModal = document.getElementById("user-info-modal");
          if (!userInfo) {
              setTimeout(() => { userModal.classList.remove("hidden"); }, 500);
          }
      }

      document.addEventListener("DOMContentLoaded", function () {
        loadCart();
        checkUserPopup();

        // N√∫t L∆∞u Info
        document.getElementById("save-user-info").addEventListener("click", function() {
            const name = document.getElementById("user-name-input").value.trim();
            const phone = document.getElementById("user-phone-input").value.trim();
            if(name && phone) {
                sessionStorage.setItem("userInfo", JSON.stringify({ name, phone }));
                document.getElementById("user-info-modal").classList.add("hidden");
            } else { alert("Vui l√≤ng ƒëi·ªÅn ƒë·∫ßy ƒë·ªß!"); }
        });

        const userModal = document.getElementById("user-info-modal");
        userModal.addEventListener("click", function(e) { if (e.target === userModal) { e.stopPropagation(); } });

        document.getElementById("global-cart-button").addEventListener("click", function(e) {
            e.preventDefault();
            renderCart();
            cartModal.classList.remove("hidden");
        });
        
        const closeCart = () => cartModal.classList.add("hidden");
        document.getElementById("close-cart-btn-x").addEventListener("click", closeCart);
        document.getElementById("close-cart-modal").addEventListener("click", closeCart);
        cartModal.addEventListener("click", (e) => { if(e.target === cartModal) closeCart(); });

        document.getElementById("clear-cart-button").addEventListener("click", function() {
            if(confirm("X√≥a h·∫øt gi·ªè h√†ng?")) {
                globalCartItems = [];
                sessionStorage.setItem("shoppingCart", JSON.stringify(globalCartItems));
                renderCart();
                updateBadge();
            }
        });

        // N√öT THANH TO√ÅN (S·ª¨A L·∫†I ƒê·ªÇ T·ª∞ ƒêI·ªÄN TH√îNG TIN)
        document.getElementById("go-to-checkout").addEventListener("click", function() {
            if(globalCartItems.length === 0) { alert("Gi·ªè h√†ng tr·ªëng!"); return; }
            cartModal.classList.add("hidden");
            
            // === T·ª∞ ƒê·ªòNG ƒêI·ªÄN T√äN T·ª™ SESSION ===
            const userInfo = JSON.parse(sessionStorage.getItem("userInfo"));
            if(userInfo) {
                document.getElementById("bill-name").value = userInfo.name || "";
                document.getElementById("bill-phone").value = userInfo.phone || "";
            }

            let total = globalCartItems.reduce((acc, item) => acc + item.price * item.quantity, 0);
            document.getElementById("bank-transfer-amount").innerText = formatCurrencyGlobal(total);

            document.getElementById("global-checkout-form-wrapper").classList.remove("hidden");
            document.getElementById("global-checkout-success").classList.add("hidden");
            checkoutModal.classList.remove("hidden");
        });

        document.getElementById("close-checkout-global").addEventListener("click", () => checkoutModal.classList.add("hidden"));

        const payRadios = document.querySelectorAll('input[name="global-payment"]');
        const bankInfo = document.getElementById("global-bank-info");
        const transCode = document.getElementById("global-transaction-code");
        const btnConfirm = document.getElementById("btn-confirm-global");

        payRadios.forEach(r => r.addEventListener('change', function() {
            if(this.value === 'bank') {
                bankInfo.classList.remove("hidden");
                transCode.classList.remove("hidden");
                btnConfirm.textContent = "X√°c nh·∫≠n ƒë√£ chuy·ªÉn ti·ªÅn";
            } else {
                bankInfo.classList.add("hidden");
                transCode.classList.add("hidden");
                btnConfirm.textContent = "X√°c nh·∫≠n ƒë·∫∑t h√†ng";
            }
        }));

        // X√ÅC NH·∫¨N ƒê·∫∂T H√ÄNG
        document.getElementById("btn-confirm-global").addEventListener("click", function() {
            const name = document.getElementById("bill-name").value.trim();
            const phone = document.getElementById("bill-phone").value.trim();
            const address = document.getElementById("bill-address").value.trim();
            const ward = document.getElementById("bill-ward").value.trim();
            const district = document.getElementById("bill-district").value.trim();
            const city = document.getElementById("bill-city").value.trim();
            
            if(!name || !phone || !address || !ward || !district || !city) {
                alert("‚ùå Vui l√≤ng ƒëi·ªÅn ƒë·∫ßy ƒë·ªß th√¥ng tin giao h√†ng!");
                return;
            }

            const paymentMethod = document.querySelector('input[name="global-payment"]:checked').value;
            if(paymentMethod === 'bank') {
                const code = document.getElementById("bill-transaction-code").value.trim();
                if(!code) {
                    alert("‚ùå Vui l√≤ng nh·∫≠p M√£ giao d·ªãch!");
                    return;
                }
            }

            let orders = JSON.parse(sessionStorage.getItem("allOrders")) || [];
            let total = globalCartItems.reduce((acc, item) => acc + item.price * item.quantity, 0);
            orders.push({
                id: Date.now(),
                customer: { name, phone, address: `${address}, ${ward}, ${district}, ${city}` },
                items: globalCartItems,
                total: total,
                date: new Date().toLocaleString()
            });
            sessionStorage.setItem("allOrders", JSON.stringify(orders));

            globalCartItems = [];
            sessionStorage.setItem("shoppingCart", JSON.stringify(globalCartItems));
            updateBadge();

            document.getElementById("global-checkout-form-wrapper").classList.add("hidden");
            document.getElementById("global-checkout-success").classList.remove("hidden");

            setTimeout(() => {
                window.location.href = "/don-hang/";
            }, 3000);
        });
      });
      
      // H√†m Mua Ngay (C≈©ng t·ª± ƒëi·ªÅn)
      window.buyNow = function(item) {
          globalCartItems.push(item);
          sessionStorage.setItem("shoppingCart", JSON.stringify(globalCartItems));
          updateBadge();
          
          // M·ªü thanh to√°n -> JS s·∫Ω t·ª± ƒëi·ªÅn
          document.getElementById("go-to-checkout").click();
      };
      
      window.addToCartLocal = function(item) {
          loadCart();
          const existing = globalCartItems.find(i => i.name === item.name && i.variant === item.variant && i.color === item.color);
          if(existing) existing.quantity += item.quantity;
          else globalCartItems.push(item);
          sessionStorage.setItem("shoppingCart", JSON.stringify(globalCartItems));
          updateBadge();
          renderCart();
          cartModal.classList.remove("hidden");
      };
    </script>
</body>
</html>