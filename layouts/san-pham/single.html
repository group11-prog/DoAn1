{{ define "main" }} {{/* Link ƒë·∫øn file CSS */}} <link rel="stylesheet" href="{{
"/css/product-style.css" | relURL }}">

<article class="product-container">
  <div class="product-grid">
    <aside class="product-gallery">
      {{ with .Params.featured_image }}
      <img src="{{ . | relURL }}" alt="{{ $.Title }}" class="main-image" />
      {{ else }}
      <img
        src="https://via.placeholder.com/600x600.png?text=Ch%C6%B0a+c%C3%B3+%E1%BA%A3nh"
        alt="Ch∆∞a c√≥ ·∫£nh"
        class="main-image"
      />
      {{ end }}
    </aside>

    <main class="product-info">
      <h1 id="product-title">{{ .Title }}</h1>
      <ul class="quick-specs">
        {{ range .Params.specifications }}
        <li>{{ . }}</li>
        {{ end }}
      </ul>

      <section class="product-section">
        <h3>Ch·ªçn dung l∆∞·ª£ng</h3>
        <div id="variant-options">
          {{ range $i, $variant := .Params.variants }}
          <input
            type="radio"
            id="variant-{{ $i }}"
            name="variant"
            value="{{ $variant.price }}"
            data-name="{{ $variant.name }}"
            {{
            if
            eq
            $i
            0
            }}checked{{
            end
            }}
          />
          <label for="variant-{{ $i }}">{{ $variant.name }}</label>
          {{ end }}
        </div>
      </section>

      <section class="product-section">
        <h3>Ch·ªçn m√†u s·∫Øc</h3>
        <div id="color-label-options">
          {{ range $i, $color := .Params.colors }}
          <input
            type="radio"
            id="color-{{ $i }}"
            name="color_option"
            value="{{ $color.name }}"
            {{
            if
            eq
            $i
            0
            }}checked{{
            end
            }}
          />
          <label for="color-{{ $i }}"> {{ $color.name }} </label>
          {{ end }}
        </div>
      </section>

      <section class="product-section">
        <h3>Ch·ªçn s·ªë l∆∞·ª£ng</h3>
        <input id="quantity" type="number" value="1" min="1" />
      </section>

      <section class="product-section gift-section">
        <h3>üéÅ Qu√† t·∫∑ng & Khuy·∫øn m√£i</h3>
        <ul class="gift-list">
          <li>B·∫£o h√†nh 1 nƒÉm ch√≠nh h√£ng.</li>
          <li>
            <span class="gift-quantity" id="gift-quantity-badge">1</span>
            c·ªß s·∫°c Belkin ch√≠nh h√£ng.
          </li>
          <li>Voucher quay s·ªë may m·∫Øn (tr·ª´ v√†o gi√°).</li>
        </ul>

        <div class="voucher-spin">
          <button id="spin-voucher-button">
            <span class="spinner"></span>
            <span class="button-text">Quay ngay ƒë·ªÉ gi·∫£m gi√°</span>
          </button>

          <div id="voucher-result-coupon" class="voucher-result-coupon hidden">
            <p class="congrats">Ch√∫c m·ª´ng!</p>
            <p class="amount" id="voucher-amount-text">500.000ƒë</p>
            <p class="info" id="voucher-info-text">ƒê√£ tr·ª´ v√†o th√†nh ti·ªÅn</p>
          </div>
        </div>
      </section>
      <section class="product-section">
        <input type="hidden" id="voucher-base-discount" value="0" />

        <h3>Th√†nh ti·ªÅn: <span id="total-price">ƒêang t√≠nh...</span></h3>

        <h4 id="final-price-display" class="hidden">
          Gi√° cu·ªëi: <span id="final-price-text"></span>
        </h4>
      </section>

      <section class="buttons">
        <button id="add-to-cart">Th√™m v√†o gi·ªè</button>
        <button id="buy-now">Mua ngay</button>
      </section>
    </main>
  </div>
  <section class="tab-section">
    <div class="tab-buttons">
      <button
        class="tab-button active"
        onclick="openTab(event, 'tab-description')"
      >
        M√¥ t·∫£ chi ti·∫øt
      </button>
      <button class="tab-button" onclick="openTab(event, 'tab-specs')">
        Th√¥ng s·ªë k·ªπ thu·∫≠t
      </button>
      <button class="tab-button" onclick="openTab(event, 'tab-reviews')">
        ƒê√°nh gi√° & B√¨nh lu·∫≠n
      </button>
    </div>
    <div id="tab-description" class="tab-content active" style="display: block">
      {{ .Content }}
    </div>
    <div id="tab-specs" class="tab-content" style="display: none">
      <h3>Th√¥ng s·ªë k·ªπ thu·∫≠t chi ti·∫øt iPhone 12</h3>
      <table class="tech-specs-table">
        <tbody>
          {{ range .Params.technical_specs }}
          <tr>
            <td>{{ .name }}</td>
            <td>{{ .value }}</td>
          </tr>
          {{ end }}
        </tbody>
      </table>
    </div>

    <div id="tab-reviews" class="tab-content" style="display: none">
      <div class="reviews-container-pro">
        <div class="reviews-summary-pro">
          <div class="summary-left">
            <div class="summary-score">
              <span class="score-number" id="summary-score-number">5</span>
              <span class="score-total">/5</span>
            </div>
            <div class="star-icons-large">‚òÖ‚òÖ‚òÖ‚òÖ‚òÖ</div>
            <div class="summary-count" id="summary-count-text">
              (8 l∆∞·ª£t ƒë√°nh gi√°)
            </div>
          </div>
          <div class="summary-right">
            <div class="rating-bar-row">
              <div class="star-label">5 ‚òÖ</div>
              <div class="rating-bar">
                <div
                  class="rating-bar-filled"
                  id="rating-bar-5"
                  style="width: 100%"
                ></div>
              </div>
              <div class="star-count" id="star-count-5">8</div>
            </div>
            <div class="rating-bar-row">
              <div class="star-label">4 ‚òÖ</div>
              <div class="rating-bar">
                <div
                  class="rating-bar-filled"
                  id="rating-bar-4"
                  style="width: 0%"
                ></div>
              </div>
              <div class="star-count" id="star-count-4">0</div>
            </div>
            <div class="rating-bar-row">
              <div class="star-label">3 ‚òÖ</div>
              <div class="rating-bar">
                <div
                  class="rating-bar-filled"
                  id="rating-bar-3"
                  style="width: 0%"
                ></div>
              </div>
              <div class="star-count" id="star-count-3">0</div>
            </div>
            <div class="rating-bar-row">
              <div class="star-label">2 ‚òÖ</div>
              <div class="rating-bar">
                <div
                  class="rating-bar-filled"
                  id="rating-bar-2"
                  style="width: 0%"
                ></div>
              </div>
              <div class="star-count" id="star-count-2">0</div>
            </div>
            <div class="rating-bar-row">
              <div class="star-label">1 ‚òÖ</div>
              <div class="rating-bar">
                <div
                  class="rating-bar-filled"
                  id="rating-bar-1"
                  style="width: 0%"
                ></div>
              </div>
              <div class="star-count" id="star-count-1">0</div>
            </div>
          </div>
        </div>

        <button class="review-write-button">ƒê√°nh gi√° s·∫£n ph·∫©m</button>

        <div class="reviews-header-pro">
          <h3 class="reviews-title-pro" id="reviews-title-pro">7 B√¨nh lu·∫≠n</h3>
          <div class="reviews-filter">
            <button class="filter-btn active" data-filter="T·∫•t c·∫£">
              T·∫•t c·∫£
            </button>
            <button class="filter-btn" data-filter="5">5 ‚òÖ</button>
            <button class="filter-btn" data-filter="4">4 ‚òÖ</button>
            <button class="filter-btn" data-filter="3">3 ‚òÖ</button>
            <button class="filter-btn" data-filter="2">2 ‚òÖ</button>
            <button class="filter-btn" data-filter="1">1 ‚òÖ</button>
          </div>
        </div>

        <div class="comment-input-area">
          <div class="comment-star-input">
            <label>ƒê√°nh gi√° c·ªßa b·∫°n:</label>
            <div class="star-rating">
              <input type="radio" id="star5" name="rating" value="5" /><label
                for="star5"
                title="5 sao"
                >‚òÖ</label
              >
              <input type="radio" id="star4" name="rating" value="4" /><label
                for="star4"
                title="4 sao"
                >‚òÖ</label
              >
              <input type="radio" id="star3" name="rating" value="3" /><label
                for="star3"
                title="3 sao"
                >‚òÖ</label
              >
              <input type="radio" id="star2" name="rating" value="2" /><label
                for="star2"
                title="2 sao"
                >‚òÖ</label
              >
              <input type="radio" id="star1" name="rating" value="1" /><label
                for="star1"
                title="1 sao"
                >‚òÖ</label
              >
            </div>
          </div>
          <textarea
            placeholder="Nh·∫≠p n·ªôi dung b√¨nh lu·∫≠n..."
            maxlength="3000"
            id="comment-textarea"
            oninput="document.getElementById('char-counter').textContent = this.value.length + '/3000'"
          ></textarea>
          <div class="comment-input-footer">
            <span id="char-counter">0/3000</span>
            <button id="submit-comment-btn">G·ª≠i b√¨nh lu·∫≠n</button>
          </div>
        </div>

        <div class="comment-list-pro" id="comment-list-pro">
          <div class="comment-item-pro" data-rating="5">
            <div class="comment-avatar">H</div>
            <div class="comment-content">
              <div class="comment-author">
                <strong>Hu·ª≥nh VƒÉn Kh√°nh</strong>
                <span>‚Ä¢ 2 th√°ng tr∆∞·ªõc</span>
              </div>
              <div class="comment-stars">‚òÖ‚òÖ‚òÖ‚òÖ‚òÖ</div>
              <p class="comment-text">
                M√¨nh mua m√°y ch·ªß y·∫øu ch∆°i game. Th·∫≠t s·ª± FPS ·ªïn ƒë·ªãnh, kh√¥ng lag,
                ƒë·ªô tr·ªÖ g·∫ßn nh∆∞ kh√¥ng c√≥. M√†n h√¨nh 16 inch v·ª´a ƒë·ªß ƒë·ªÉ quan s√°t c√°c
                chi ti·∫øt nh·ªè trong game. Qu·∫°t h∆°i ·ªìn khi ch∆°i l√¢u nh∆∞ng kh√¥ng
                kh√≥ ch·ªãu
              </p>
            </div>
          </div>

          <div class="comment-item-pro" data-rating="5">
            <div class="comment-avatar">T</div>
            <div class="comment-content">
              <div class="comment-author">
                <strong>VƒÉn Qu√Ω</strong>
                <span>‚Ä¢ 2 th√°ng tr∆∞·ªõc</span>
              </div>
              <div class="comment-stars">‚òÖ‚òÖ‚òÖ‚òÖ‚òÖ</div>
              <p class="comment-text">Nh√¨n chung ƒë√°p ·ª©ng t·ªët</p>
            </div>
          </div>

          <div class="comment-item-pro" data-rating="5">
            <div class="comment-avatar">V</div>
            <div class="comment-content">
              <div class="comment-author">
                <strong>V√µ Ng·ªçc B√≠ch</strong>
                <span>‚Ä¢ 2 th√°ng tr∆∞·ªõc</span>
              </div>
              <div class="comment-stars">‚òÖ‚òÖ‚òÖ‚òÖ‚òÖ</div>
              <p class="comment-text">
                Nh√¢n vi√™n h·ªó tr·ª£ c√†i ƒë·∫∑t mi·ªÖn ph√≠ c√°c ·ª©ng d·ª•ng c∆° b·∫£n, nhi·ªát
                t√¨nh l·∫Øm
              </p>
            </div>
          </div>
        </div>
      </div>
    </div>
  </section>

  <a id="floating-cart-button" class="hidden">
    <span class="cart-icon">üõí</span>
    <span id="floating-cart-count" class="cart-badge">0</span>
  </a>
  <div id="confirmation-modal" class="modal-overlay hidden">
    <div class="modal-content">
      <span class="close-modal" id="close-confirm-btn-x">&times;</span>
      <h2>X√°c nh·∫≠n</h2>
      <p>B·∫°n c√≥ ch·∫Øc mu·ªën th√™m s·∫£n ph·∫©m n√†y v√†o gi·ªè h√†ng?</p>
      <div class="cart-buttons">
        <button id="cancel-add-to-cart">H·ªßy</button>
        <button id="confirm-add-to-cart">X√°c nh·∫≠n</button>
      </div>
    </div>
  </div>
  <div id="cart-modal" class="modal-overlay hidden">
    <div class="modal-content">
      <span class="close-modal" id="close-cart-btn-x">&times;</span>
      <h2>Gi·ªè h√†ng c·ªßa b·∫°n</h2>

      <ul id="cart-item-list"></ul>

      <div class="cart-total">
        <strong>T·ªïng c·ªông:</strong>
        <strong id="cart-total-price">0ƒë</strong>
      </div>

      <button id="clear-cart-button">X√≥a gi·ªè h√†ng</button>

      <div class="cart-buttons">
        <button id="close-cart-modal">Ti·∫øp t·ª•c mua s·∫Øm</button>
        <button id="go-to-checkout">ƒêi ƒë·∫øn thanh to√°n</button>
      </div>
    </div>
  </div>
  <div id="checkout-modal" class="modal-overlay hidden">
    <div class="modal-content">
      <span class="close-modal" id="close-modal-btn">&times;</span>
      <h2>Th√¥ng tin thanh to√°n</h2>
      <div id="checkout-form">
        <div class="form-group">
          <label for="fullname">H·ªç v√† T√™n</label>
          <input type="text" id="fullname" placeholder="Nguy·ªÖn VƒÉn A" />
        </div>
        <div class="form-group">
          <label for="phone">S·ªë ƒëi·ªán tho·∫°i</label>
          <input type="tel" id="phone" placeholder="09xxxxxxxx" />
        </div>
        <div class="form-group">
          <label for="address">ƒê·ªãa ch·ªâ (S·ªë nh√†, T√™n ƒë∆∞·ªùng)</label>
          <input type="text" id="address" placeholder="123 ƒê∆∞·ªùng ABC" />
        </div>
        <div class="address-grid">
          <div class="form-group">
            <label for="ward">Ph∆∞·ªùng/X√£</label>
            <input type="text" id="ward" placeholder="Ph∆∞·ªùng 1" />
          </div>
          <div class="form-group">
            <label for="district">Qu·∫≠n/Huy·ªán</label>
            <input type="text" id="district" placeholder="Qu·∫≠n 1" />
          </div>
        </div>
        <div class="form-group">
          <label for="city">T·ªânh/Th√†nh ph·ªë</label>
          <input type="text" id="city" placeholder="TP. H·ªì Ch√≠ Minh" />
        </div>
        <hr />
        <div class="form-group">
          <h3>Ph∆∞∆°ng th·ª©c thanh to√°n</h3>
          <div class="payment-options">
            <label>
              <input type="radio" name="payment" value="cod" checked /> Thanh
              to√°n khi nh·∫≠n h√†ng (COD)
            </label>
            <label>
              <input type="radio" name="payment" value="bank" /> Chuy·ªÉn kho·∫£n
              ng√¢n h√†ng
            </label>
          </div>
        </div>
        <div id="bank-info-details" class="hidden">
          <h4>Th√¥ng tin chuy·ªÉn kho·∫£n</h4>
          <ul>
            <li>
              S·ªë ti·ªÅn: <strong id="bank-amount" style="color: #d70018"></strong>
            </li>
            <li>Ng√¢n h√†ng: <strong>MB Bank (Ng√¢n h√†ng Qu√¢n ƒë·ªôi)</strong></li>
            <li>S·ªë t√†i kho·∫£n: <strong>0123456789</strong></li>
            <li>Ch·ªß t√†i kho·∫£n: <strong>NGUYEN VAN A</strong></li>
            <li>N·ªôi dung: <strong>[S·ªë ƒëi·ªán tho·∫°i c·ªßa b·∫°n]</strong></li>
          </ul>
        </div>
        <div id="transaction-code-group" class="form-group hidden">
          <label for="transaction-code">M√£ giao d·ªãch</label>
          <input
            type="text"
            id="transaction-code"
            placeholder="Nh·∫≠p m√£ giao d·ªãch t·ª´ ng√¢n h√†ng c·ªßa b·∫°n"
          />
        </div>
        <button id="confirm-order">X√°c nh·∫≠n ƒë·∫∑t h√†ng</button>
      </div>
      <div id="checkout-success" class="hidden" style="text-align: center">
        <h2 style="color: #28a745">ƒê·∫∑t h√†ng th√†nh c√¥ng!</h2>
        <p>C·∫£m ∆°n b·∫°n ƒë√£ mua h√†ng</p>
        <p>Ch√∫ng t√¥i s·∫Ω chuy·ªÉn h∆∞·ªõng sau 3 gi√¢y...</p>
      </div>
    </div>
  </div>
</article>

<script>
  // Bi·∫øn to√†n c·ª•c
  let cartItems = [];
  let tempProductToAdd = null;
  let currentCheckoutItems = [];
  let filterButtons = null;
  let commentItems = null;

  /* ============================================= */
  /* H√ÄM TI·ªÜN √çCH (Functions)
    /* ============================================= */

  // --- H√ÄM 1 -> 9 (Kh√¥ng thay ƒë·ªïi) ---
  function updateTotalPrice() {
    const variantRadios = document.querySelectorAll(
      '#variant-options input[name="variant"]'
    );
    const quantityInput = document.getElementById("quantity");
    const totalPriceEl = document.getElementById("total-price");
    let selectedPrice = 0;

    if (!quantityInput || !totalPriceEl || !variantRadios) return;

    for (const radio of variantRadios) {
      if (radio.checked) {
        selectedPrice = parseFloat(radio.value);
        break;
      }
    }
    const quantity = parseInt(quantityInput.value);
    const total = selectedPrice * quantity;
    totalPriceEl.textContent = formatCurrency(total);
    const giftBadgeEl = document.getElementById("gift-quantity-badge");
    if (giftBadgeEl) {
      giftBadgeEl.textContent = quantity;
    }
    const baseVoucherDiscount = parseFloat(
      document.getElementById("voucher-base-discount").value
    );
    const totalVoucherDiscount = baseVoucherDiscount * quantity;
    const finalPriceDisplay = document.getElementById("final-price-display");
    const finalPriceText = document.getElementById("final-price-text");
    const voucherInfoText = document.getElementById("voucher-info-text");
    if (totalVoucherDiscount > 0 && totalVoucherDiscount < total) {
      const finalTotal = total - totalVoucherDiscount;
      totalPriceEl.style.textDecoration = "line-through";
      totalPriceEl.style.color = "#888";
      totalPriceEl.style.fontSize = "1.5em";
      finalPriceText.textContent = formatCurrency(finalTotal);
      finalPriceDisplay.classList.remove("hidden");
      if (quantity > 1 && voucherInfoText) {
        voucherInfoText.textContent = `ƒê√£ √°p d·ª•ng ${formatCurrency(
          totalVoucherDiscount
        )} (x${quantity}) v√†o th√†nh ti·ªÅn`;
      } else if (voucherInfoText) {
        voucherInfoText.textContent = "ƒê√£ tr·ª´ v√†o th√†nh ti·ªÅn";
      }
    } else {
      totalPriceEl.style.textDecoration = "none";
      totalPriceEl.style.color = "#d70018";
      totalPriceEl.style.fontSize = "2em";
      finalPriceDisplay.classList.add("hidden");
      if (voucherInfoText) {
        voucherInfoText.textContent = "ƒê√£ tr·ª´ v√†o th√†nh ti·ªÅn";
      }
    }
  }
  function openTab(evt, tabName) {
    var tabContents = document.querySelectorAll(".tab-content");
    tabContents.forEach((tab) => (tab.style.display = "none"));
    var tabButtons = document.querySelectorAll(".tab-button");
    tabButtons.forEach((btn) => btn.classList.remove("active"));
    document.getElementById(tabName).style.display = "block";
    evt.currentTarget.classList.add("active");
  }
  function formatCurrency(value) {
    return new Intl.NumberFormat("vi-VN", {
      style: "currency",
      currency: "VND",
    }).format(value);
  }
  function getSelectedPriceValue() {
    const variantRadio = document.querySelector(
      '#variant-options input[name="variant"]:checked'
    );
    return variantRadio ? parseFloat(variantRadio.value) : 0;
  }
  function saveCart() {
    localStorage.setItem("shoppingCart", JSON.stringify(cartItems));
    updateFloatingCartIcon();
  }
  function loadCart() {
    cartItems = JSON.parse(localStorage.getItem("shoppingCart")) || [];
    updateFloatingCartIcon();
  }
  function updateFloatingCartIcon() {
    const floatingCartButton = document.getElementById("floating-cart-button");
    const cartCountBadge = document.getElementById("floating-cart-count");
    if (!floatingCartButton || !cartCountBadge) return;
    if (cartItems.length > 0) {
      const totalQuantity = cartItems.reduce(
        (acc, item) => acc + item.quantity,
        0
      );
      cartCountBadge.textContent = totalQuantity;
      floatingCartButton.classList.remove("hidden");
    } else {
      floatingCartButton.classList.add("hidden");
    }
  }
  function renderCartModal() {
    const cartItemList = document.getElementById("cart-item-list");
    const cartTotalPrice = document.getElementById("cart-total-price");
    let total = 0;
    cartItemList.innerHTML = "";
    if (cartItems.length === 0) {
      cartItemList.innerHTML = "<li>Gi·ªè h√†ng c·ªßa b·∫°n ƒëang tr·ªëng.</li>";
      cartTotalPrice.textContent = formatCurrency(0);
      return;
    }
    cartItems.forEach((item) => {
      const itemTotal = item.price * item.quantity;
      total += itemTotal;
      const itemHTML = `
                <li>
                    <div class="item-info">
                        <strong>${item.name}</strong>
                        <span>${item.variant}, ${item.color} (x${
        item.quantity
      })</span>
                    </div>
                    <div class="item-price">${formatCurrency(itemTotal)}</div>
                </li>
            `;
      cartItemList.innerHTML += itemHTML;
    });
    cartTotalPrice.textContent = formatCurrency(total);
  }
  function addToCart(product) {
    if (!product) return;
    const existingItem = cartItems.find(
      (item) =>
        item.name === product.name &&
        item.variant === product.variant &&
        item.color === product.color
    );
    if (existingItem) {
      existingItem.quantity += product.quantity;
    } else {
      cartItems.push(product);
    }
    saveCart();
  }

  // --- H√ÄM 10 (G·∫Øn logic cho b·ªô l·ªçc) ---
  function attachFilterListeners() {
    filterButtons = document.querySelectorAll(".reviews-filter .filter-btn");
    commentItems = document.querySelectorAll(
      ".comment-list-pro .comment-item-pro"
    );

    if (!filterButtons || !commentItems) return;

    filterButtons.forEach((button) => {
      button.addEventListener("click", function () {
        filterButtons.forEach((btn) => btn.classList.remove("active"));
        this.classList.add("active");
        const filterValue = this.dataset.filter;

        commentItems.forEach((comment) => {
          if (filterValue === "T·∫•t c·∫£") {
            comment.style.display = "flex";
          } else {
            if (comment.dataset.rating === filterValue) {
              comment.style.display = "flex";
            } else {
              comment.style.display = "none";
            }
          }
        });
      });
    });
  }

  // --- M·ªöI: H√ÄM 12 (T√çNH TO√ÅN L·∫†I T√ìM T·∫ÆT ƒê√ÅNH GI√Å) ---
  function updateRatingSummary() {
    // 1. L·∫•y t·∫•t c·∫£ b√¨nh lu·∫≠n (c≈© v√† m·ªõi)
    const allCommentItems = document.querySelectorAll(
      ".comment-list-pro .comment-item-pro"
    );

    let totalReviews = 0;
    let totalScore = 0;
    let starCounts = { 5: 0, 4: 0, 3: 0, 2: 0, 1: 0 };

    // 2. ƒê·∫øm
    allCommentItems.forEach((comment) => {
      const rating = parseInt(comment.dataset.rating);
      if (rating >= 1 && rating <= 5) {
        totalReviews++;
        totalScore += rating;
        starCounts[rating]++;
      }
    });

    // 3. T√≠nh to√°n
    const averageRating =
      totalReviews > 0 ? (totalScore / totalReviews).toFixed(1) : 0;

    // 4. C·∫≠p nh·∫≠t HTML
    document.getElementById("summary-score-number").textContent = averageRating;
    document.getElementById(
      "summary-count-text"
    ).textContent = `(${totalReviews} l∆∞·ª£t ƒë√°nh gi√°)`;
    document.getElementById(
      "reviews-title-pro"
    ).textContent = `${totalReviews} B√¨nh lu·∫≠n`;

    for (let i = 1; i <= 5; i++) {
      const percentage =
        totalReviews > 0 ? (starCounts[i] / totalReviews) * 100 : 0;
      document.getElementById(`rating-bar-${i}`).style.width = percentage + "%";
      document.getElementById(`star-count-${i}`).textContent = starCounts[i];
    }
  }

  /* ============================================= */
  /* CH·∫†Y CODE KHI TRANG ƒê√É T·∫¢I XONG 100%
    /* ============================================= */
  document.addEventListener("DOMContentLoaded", function () {
    // --- LOGIC CHUNG (ch·∫°y tr√™n m·ªçi trang) ---
    loadCart();

    const cartModal = document.getElementById("cart-modal");
    const closeCartBtnX = document.getElementById("close-cart-btn-x");
    const closeCartModalBtn = document.getElementById("close-cart-modal");
    const goToCheckoutBtn = document.getElementById("go-to-checkout");
    const clearCartBtn = document.getElementById("clear-cart-button");
    if (closeCartBtnX) {
      closeCartBtnX.addEventListener("click", function () {
        cartModal.classList.add("hidden");
      });
    }
    if (closeCartModalBtn) {
      closeCartModalBtn.addEventListener("click", function () {
        cartModal.classList.add("hidden");
      });
    }
    if (goToCheckoutBtn) {
      goToCheckoutBtn.addEventListener("click", function () {
        cartModal.classList.add("hidden");
        currentCheckoutItems = [...cartItems];
        const cartTotal = cartItems.reduce(
          (acc, item) => acc + item.price * item.quantity,
          0
        );
        const checkoutModal = document.getElementById("checkout-modal");
        const bankAmountSpan = document.getElementById("bank-amount");
        if (checkoutModal && bankAmountSpan) {
          bankAmountSpan.textContent = formatCurrency(cartTotal);
          checkoutModal.classList.remove("hidden");
        }
      });
    }
    if (cartModal) {
      cartModal.addEventListener("click", function (e) {
        if (e.target === cartModal) {
          cartModal.classList.add("hidden");
        }
      });
    }
    if (clearCartBtn) {
      clearCartBtn.addEventListener("click", function () {
        cartItems = [];
        saveCart();
        renderCartModal();
        updateFloatingCartIcon();
      });
    }
    const floatingCartButton = document.getElementById("floating-cart-button");
    if (floatingCartButton) {
      floatingCartButton.addEventListener("click", function () {
        renderCartModal();
        cartModal.classList.remove("hidden");
      });
    }

    // --- "C·∫¶U DAO AN TO√ÄN" ---
    const productTitleElement = document.getElementById("product-title");
    if (!productTitleElement) {
      return;
    }

    // T·ª™ ƒê√ÇY TR·ªû XU·ªêNG: L√Ä SCRIPT CH·ªà CH·∫†Y TR√äN TRANG S·∫¢N PH·∫®M
    const productTitle = productTitleElement.textContent;
    let userInfo = JSON.parse(localStorage.getItem("userInfo"));

    // --- LOGIC 1: T√çNH GI√Å S·∫¢N PH·∫®M ---
    const variantRadios_DOM = document.querySelectorAll(
      '#variant-options input[name="variant"]'
    );
    const quantityInput_DOM = document.getElementById("quantity");
    if (quantityInput_DOM) {
      variantRadios_DOM.forEach((radio) => {
        radio.addEventListener("change", updateTotalPrice);
      });
      quantityInput_DOM.addEventListener("input", updateTotalPrice);
      updateTotalPrice();
    }

    // --- LOGIC 2: M·ªû POPUP X√ÅC NH·∫¨N ---
    const cartButton = document.getElementById("add-to-cart");
    const confirmationModal = document.getElementById("confirmation-modal");
    if (cartButton) {
      cartButton.addEventListener("click", function () {
        const selectedVariantRadio = document.querySelector(
          '#variant-options input[name="variant"]:checked'
        );
        const selectedColorRadio = document.querySelector(
          '#color-label-options input[name="color_option"]:checked'
        );
        const basePrice = getSelectedPriceValue();
        const baseVoucher = parseFloat(
          document.getElementById("voucher-base-discount").value
        );
        let finalUnitPrice = basePrice;
        if (baseVoucher > 0 && baseVoucher < basePrice) {
          finalUnitPrice = basePrice - baseVoucher;
        }
        tempProductToAdd = {
          name: productTitle,
          variant: selectedVariantRadio
            ? selectedVariantRadio.dataset.name
            : "",
          color: selectedColorRadio ? selectedColorRadio.value : "",
          quantity: parseInt(quantityInput_DOM.value),
          price: finalUnitPrice,
        };
        confirmationModal.classList.remove("hidden");
      });
    }

    // --- LOGIC 3, 4, 5 (Logic Mua h√†ng & Checkout) ---
    const buyNowButton = document.getElementById("buy-now");
    const checkoutModal = document.getElementById("checkout-modal");
    const closeModalBtn = document.getElementById("close-modal-btn");
    const confirmOrderBtn = document.getElementById("confirm-order");
    const checkoutForm = document.getElementById("checkout-form");
    const checkoutSuccess = document.getElementById("checkout-success");
    const paymentRadios = document.querySelectorAll('input[name="payment"]');
    const bankInfoDetails = document.getElementById("bank-info-details");
    const bankAmountSpan = document.getElementById("bank-amount");
    const transactionCodeGroup = document.getElementById(
      "transaction-code-group"
    );
    const transactionCodeInput = document.getElementById("transaction-code");

    if (buyNowButton) {
      buyNowButton.addEventListener("click", function () {
        const basePrice = getSelectedPriceValue();
        const baseVoucher = parseFloat(
          document.getElementById("voucher-base-discount").value
        );
        let finalUnitPrice =
          baseVoucher > 0 && baseVoucher < basePrice
            ? basePrice - baseVoucher
            : basePrice;
        currentCheckoutItems = [
          {
            name: productTitle,
            variant: document.querySelector(
              '#variant-options input[name="variant"]:checked'
            ).dataset.name,
            color: document.querySelector(
              '#color-label-options input[name="color_option"]:checked'
            ).value,
            quantity: parseInt(quantityInput_DOM.value),
            price: finalUnitPrice,
          },
        ];

        // T·ª± ƒë·ªông ƒëi·ªÅn th√¥ng tin
        if (userInfo && userInfo.name) {
          document.getElementById("fullname").value = userInfo.name;
        }
        if (userInfo && userInfo.phone) {
          document.getElementById("phone").value = userInfo.phone;
        }

        const quantity = parseInt(quantityInput_DOM.value);
        const totalVoucherDiscount = baseVoucher * quantity;
        const currentTotal = basePrice * quantity;
        const finalTotal = currentTotal - totalVoucherDiscount;
        bankAmountSpan.textContent = formatCurrency(
          finalTotal > 0 ? finalTotal : 0
        );
        checkoutModal.classList.remove("hidden");
      });
    }
    if (closeModalBtn) {
      closeModalBtn.addEventListener("click", function () {
        checkoutModal.classList.add("hidden");
      });
    }
    if (checkoutModal) {
      checkoutModal.addEventListener("click", function (e) {
        if (e.target === checkoutModal) {
          checkoutModal.classList.add("hidden");
        }
      });
    }
    if (paymentRadios) {
      paymentRadios.forEach((radio) => {
        radio.addEventListener("change", function () {
          if (this.value === "bank") {
            bankInfoDetails.classList.remove("hidden");
            transactionCodeGroup.classList.remove("hidden");
            confirmOrderBtn.textContent = "X√°c nh·∫≠n ƒë√£ chuy·ªÉn ti·ªÅn";
          } else {
            bankInfoDetails.classList.add("hidden");
            transactionCodeGroup.classList.add("hidden");
            confirmOrderBtn.textContent = "X√°c nh·∫≠n ƒë·∫∑t h√†ng";
          }
        });
      });
    }
    if (confirmOrderBtn) {
      confirmOrderBtn.addEventListener("click", function () {
        const selectedPayment = document.querySelector(
          'input[name="payment"]:checked'
        ).value;
        function showSuccess() {
          try {
            let allOrders = JSON.parse(localStorage.getItem("allOrders")) || [];
            const finalTotal = parseFloat(
              bankAmountSpan.textContent.replace(/[^0-9]/g, "")
            );
            const newOrder = {
              orderId: `DH-${new Date().getTime()}`,
              date: new Date().toISOString(),
              items: currentCheckoutItems,
              totalAmount: finalTotal,
              customerInfo: {
                name: document.getElementById("fullname").value,
                phone: document.getElementById("phone").value,
                address: `${document.getElementById("address").value}, ${
                  document.getElementById("ward").value
                }, ${document.getElementById("district").value}, ${
                  document.getElementById("city").value
                }`,
              },
            };
            allOrders.push(newOrder);
            localStorage.setItem("allOrders", JSON.stringify(allOrders));
            const cartTotal = cartItems.reduce(
              (acc, item) => acc + item.price * item.quantity,
              0
            );
            if (cartItems.length > 0 && cartTotal === finalTotal) {
              cartItems = [];
              saveCart();
            }
            currentCheckoutItems = [];
          } catch (e) {
            console.error("Kh√¥ng th·ªÉ l∆∞u ƒë∆°n h√†ng:", e);
          }
          checkoutForm.classList.add("hidden");
          checkoutSuccess.classList.remove("hidden");
          setTimeout(function () {
            checkoutModal.classList.add("hidden");
            checkoutForm.classList.remove("hidden");
            checkoutSuccess.classList.add("hidden");
            bankInfoDetails.classList.add("hidden");
            transactionCodeGroup.classList.add("hidden");
            transactionCodeInput.value = "";
            document.querySelector('input[value="cod"]').checked = true;
            document.getElementById("fullname").value = "";
            document.getElementById("phone").value = "";
            document.getElementById("address").value = "";
            document.getElementById("ward").value = "";
            document.getElementById("district").value = "";
            document.getElementById("city").value = "";
            window.location.href = "/don-hang/";
          }, 3000);
        }
        if (selectedPayment === "bank") {
          const txCode = transactionCodeInput.value;
          if (txCode.trim() === "") {
            alert("Vui l√≤ng nh·∫≠p M√£ giao d·ªãch ƒë·ªÉ x√°c nh·∫≠n.");
          } else {
            showSuccess();
          }
        } else {
          showSuccess();
        }
      });
    }

    // --- LOGIC 7 (Modal X√°c nh·∫≠n) ---
    const closeConfirmBtnX = document.getElementById("close-confirm-btn-x");
    const cancelAddBtn = document.getElementById("cancel-add-to-cart");
    const confirmAddBtn = document.getElementById("confirm-add-to-cart");
    if (closeConfirmBtnX) {
      closeConfirmBtnX.addEventListener("click", function () {
        confirmationModal.classList.add("hidden");
        tempProductToAdd = null;
      });
    }
    if (cancelAddBtn) {
      cancelAddBtn.addEventListener("click", function () {
        confirmationModal.classList.add("hidden");
        tempProductToAdd = null;
      });
    }
    if (confirmAddBtn) {
      confirmAddBtn.addEventListener("click", function () {
        addToCart(tempProductToAdd);
        tempProductToAdd = null;
        confirmationModal.classList.add("hidden");
      });
    }

    // --- LOGIC 9 (V√íNG QUAY VOUCHER) ---
    const spinButton = document.getElementById("spin-voucher-button");
    const voucherResultCoupon = document.getElementById(
      "voucher-result-coupon"
    );
    const voucherAmountText = document.getElementById("voucher-amount-text");
    const voucherSpunKey = "voucherSpun_" + productTitle;
    const voucherAmountKey = "voucherAmount_" + productTitle;
    if (sessionStorage.getItem(voucherSpunKey)) {
      const storedAmount = parseFloat(sessionStorage.getItem(voucherAmountKey));
      if (storedAmount > 0) {
        document.getElementById("voucher-base-discount").value = storedAmount;
        voucherAmountText.textContent = formatCurrency(storedAmount);
        voucherResultCoupon.classList.remove("hidden");
        spinButton.classList.add("hidden");
        updateTotalPrice();
      }
    }
    if (spinButton) {
      spinButton.addEventListener("click", function () {
        spinButton.disabled = true;
        spinButton.classList.add("spinning");
        spinButton.querySelector(".button-text").textContent = "ƒêang quay...";
        setTimeout(function () {
          const prizes = [
            { value: 1000000, weight: 5 },
            { value: 500000, weight: 15 },
            { value: 200000, weight: 30 },
            { value: 100000, weight: 50 },
          ];
          const weightedList = [];
          prizes.forEach((p) => {
            for (let i = 0; i < p.weight; i++) {
              weightedList.push(p.value);
            }
          });
          const randomPick =
            weightedList[Math.floor(Math.random() * weightedList.length)];
          document.getElementById("voucher-base-discount").value = randomPick;
          voucherAmountText.textContent = formatCurrency(randomPick);
          spinButton.classList.add("hidden");
          voucherResultCoupon.classList.remove("hidden");
          sessionStorage.setItem(voucherSpunKey, "true");
          sessionStorage.setItem(voucherAmountKey, randomPick);
          updateTotalPrice();
        }, 2000);
      });
    }

    // --- LOGIC 10 (L·ªåC B√åNH LU·∫¨N) ---
    attachFilterListeners();

    // --- LOGIC 11 (G·ª¨I B√åNH LU·∫¨N) ---
    const submitCommentBtn = document.getElementById("submit-comment-btn");
    const commentTextarea = document.getElementById("comment-textarea");
    const commentListContainer = document.getElementById("comment-list-pro");

    if (submitCommentBtn) {
      submitCommentBtn.addEventListener("click", function (e) {
        e.preventDefault();

        const commentText = commentTextarea.value.trim();
        const ratingInput = document.querySelector(
          '.comment-star-input input[name="rating"]:checked'
        );

        if (!ratingInput) {
          alert("Vui l√≤ng ch·ªçn s·ªë sao ƒë√°nh gi√°.");
          return;
        }
        if (commentText === "") {
          alert("Vui l√≤ng nh·∫≠p n·ªôi dung b√¨nh lu·∫≠n.");
          return;
        }

        const ratingValue = ratingInput.value;
        const starText = "‚òÖ".repeat(ratingValue) + "‚òÜ".repeat(5 - ratingValue);

        let userName = userInfo && userInfo.name ? userInfo.name : "Kh√°ch";
        let avatarLetter = userName.charAt(0).toUpperCase();

        const newCommentHTML = `
          <div class="comment-item-pro" data-rating="${ratingValue}">
            <div class="comment-avatar">${avatarLetter}</div>
            <div class="comment-content">
              <div class="comment-author">
                <strong>${userName}</strong>
                <span>‚Ä¢ v·ª´a xong</span>
              </div>
              <div class="comment-stars">${starText}</div>
              <p class="comment-text">${commentText}</p>
            </div>
          </div>
        `;

        commentListContainer.insertAdjacentHTML("afterbegin", newCommentHTML);

        commentTextarea.value = "";
        ratingInput.checked = false;
        document.getElementById("char-counter").textContent = "0/3000";

        // C·∫¨P NH·∫¨T L·∫†I B·ªò L·ªåC V√Ä T√ìM T·∫ÆT
        attachFilterListeners();
        updateRatingSummary(); // <-- M·ªöI: G·ªçi h√†m t√≠nh to√°n l·∫°i
      });
    }

    // --- M·ªöI: LOGIC 12 (T√çNH TO√ÅN BAN ƒê·∫¶U) ---
    // Ch·∫°y h√†m t√≠nh to√°n t√≥m t·∫Øt 1 l·∫ßn khi t·∫£i trang
    updateRatingSummary();
  }); // <-- K·∫øt th√∫c DOMContentLoaded
</script>

{{ end }}
