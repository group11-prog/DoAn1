{{ define "main" }}
<link
  rel="stylesheet"
  href="{{ "/css/product-style.css" | relURL }}"
/>

<div class="main-container">
  <div class="main-header">
    {{ with .Site.Params.logo }}
    <div class="logo-container">
      <img
        src="{{ . | relURL }}"
        alt="Logo"
        class="logo"
      />
    </div>
    {{ end }}
    <h1 class="site-title">{{ .Site.Title }}</h1>
    {{ with .Site.Params.description }}
    <p class="site-subtitle">{{ . }}</p>
    {{ end }}

    <div class="search-container">
      <input type="text" id="search-input" placeholder="TÃ¬m kiáº¿m">
      <i class="fas fa-search search-icon"></i>
      <div id="search-results-container" class="search-results-container hidden">
        </div>
    </div>
    </div>
</div>

<div class="homepage-content">
  <h2 class="homepage-section-title">{{ .Site.Params.author.headline | default "Danh Má»¥c Sáº£n Pháº©m" }}</h2>
  <div class="series-grid-container">
    {{/* Äá»c dá»¯ liá»‡u tá»« data/series.toml */}}
    {{ range .Site.Data.series.card }}
    <a href="{{ .url | relURL }}" class="series-card-link">
      <div class="series-card">
        <div class="series-image-wrapper">
          <img
            src="{{ .image | relURL }}"
            alt="{{ .name }}"
            class="series-image"
          />
        </div>
        <h3 class="series-name">{{ .name }}</h3>
      </div>
    </a>
    {{ end }}
  </div>
</div>

<div id="user-info-modal" class="modal-overlay hidden">
  <div class="modal-content" style="max-width: 400px;">
    
    <span class="close-modal" id="close-welcome-modal">&times;</span>
    <h2>ChÃ o má»«ng!</h2>
    <p>Vui lÃ²ng nháº­p tÃªn cá»§a báº¡n Ä‘á»ƒ bÃ¬nh luáº­n (chá»‰ cáº§n nháº­p 1 láº§n):</p>

    <div class="voucher-promo-message">
      ğŸ‰ Táº·ng voucher giáº£m giÃ¡ khi báº¡n lÃ  SINH VIÃŠN ÄH KHTN !!! ğŸ†
    </div>

    <div id="user-info-form">
      <div class="form-group">
        <label for="user-name">TÃªn cá»§a báº¡n</label>
        <input type="text" id="user-name" placeholder="Nguyá»…n VÄƒn A" required>
      </div>
      <div class="form-group">
        <label for="user-phone">Sá»‘ Ä‘iá»‡n thoáº¡i (TÃ¹y chá»n)</label>
        <input type="tel" id="user-phone" placeholder="09xxxxxxxx">
      </div>
      <button id="save-user-info">LÆ°u thÃ´ng tin</button>
    </div>
  </div>
</div>


<script>
  document.addEventListener("DOMContentLoaded", function () {
    
    // --- LOGIC 1: RESET KHI REFRESH ---
    try {
      const navigationEntries = performance.getEntriesByType("navigation");
      if (navigationEntries.length > 0) {
        const navType = navigationEntries[0].type;
        if (navType === "reload") {
          console.log(
            "PhÃ¡t hiá»‡n REFRESH trang, Ä‘ang xÃ³a dá»¯ liá»‡u test..."
          );
          localStorage.removeItem("allOrders");
          localStorage.removeItem("shoppingCart");
          localStorage.removeItem("userInfo");
        }
      }
    } catch (e) {
      console.error("KhÃ´ng thá»ƒ kiá»ƒm tra navigation type:", e);
    }
    
    // --- Má»šI: LOGIC 2 (KIá»‚M TRA THÃ”NG TIN USER) ---
    const userInfoModal = document.getElementById("user-info-modal");
    const saveUserInfoBtn = document.getElementById("save-user-info");
    const userNameInput = document.getElementById("user-name");
    const userPhoneInput = document.getElementById("user-phone");
    
    // --- Má»šI: Láº¥y nÃºt X ---
    const closeWelcomeModalBtn = document.getElementById("close-welcome-modal");

    let userInfo = JSON.parse(localStorage.getItem("userInfo"));
    if (!userInfo || !userInfo.name) {
      userInfoModal.classList.remove("hidden");
    }

    saveUserInfoBtn.addEventListener("click", function() {
      const name = userNameInput.value.trim();
      const phone = userPhoneInput.value.trim();

      if (name === "") {
        alert("Vui lÃ²ng nháº­p tÃªn cá»§a báº¡n.");
        return;
      }
      
      userInfo = { name: name, phone: phone };
      localStorage.setItem("userInfo", JSON.stringify(userInfo));
      
      userInfoModal.classList.add("hidden");
    });
    
    // --- Má»šI: ThÃªm sá»± kiá»‡n click cho nÃºt X ---
    if (closeWelcomeModalBtn) {
      closeWelcomeModalBtn.addEventListener("click", function() {
        userInfoModal.classList.add("hidden");
      });
    }
    // --- Káº¾T THÃšC LOGIC 2 ---


    // --- Má»šI: LOGIC 3 (TÃŒM KIáº¾M Sáº¢N PHáº¨M) ---
    const searchInput = document.getElementById("search-input");
    const resultsContainer = document.getElementById("search-results-container");
    let searchData = [];

    // 1. Táº£i "database" JSON
    fetch('/index.json')
      .then(response => response.json())
      .then(data => {
        searchData = data;
      })
      .catch(error => console.error('Lá»—i táº£i search.json:', error));

    // 2. Láº¯ng nghe sá»± kiá»‡n gÃµ phÃ­m
    searchInput.addEventListener("input", function(e) {
      const query = e.target.value.toLowerCase().trim();
      
      if (query.length < 2) {
        resultsContainer.innerHTML = "";
        resultsContainer.classList.add("hidden");
        return;
      }

      // 3. Lá»c dá»¯ liá»‡u
      const results = searchData.filter(item => 
        item.title.toLowerCase().includes(query)
      );

      // 4. Hiá»ƒn thá»‹ káº¿t quáº£
      if (results.length > 0) {
        let html = "";
        results.forEach(item => {
          html += `
            <a href="${item.url}" class="search-result-item">
              <img src="${item.image}" alt="${item.title}" class="search-result-image">
              <span class="search-result-title">${item.title}</span>
            </a>
          `;
        });
        resultsContainer.innerHTML = html;
        resultsContainer.classList.remove("hidden");
      } else {
        resultsContainer.innerHTML = `<div class="search-no-results">KhÃ´ng tÃ¬m tháº¥y sáº£n pháº©m nÃ o.</div>`;
        resultsContainer.classList.remove("hidden");
      }
    });

    // 5. áº¨n káº¿t quáº£ khi click ra ngoÃ i
    document.addEventListener("click", function(e) {
      if (!resultsContainer.contains(e.target) && e.target !== searchInput) {
        resultsContainer.classList.add("hidden");
      }
    });
    // --- Káº¾T THÃšC LOGIC 3 ---

  });
</script>
{{ end }}