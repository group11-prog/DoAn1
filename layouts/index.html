{{ define "main" }}
<div class="home-container">
    
    <div class="home-header">
        <img src="/images/Logo-dai-hoc-khoa-hoc-tu-nhien.png" alt="Logo KHTN" class="school-logo">
        
        <h1 class="shop-name">Mobile Center</h1>
        <p class="sub-text">Chào mừng đến với cửa hàng !!!</p>
        
        <div class="search-container">
            <div class="search-wrapper">
                <input type="text" id="search-input" placeholder="Nhập tên iPhone cần tìm..." autocomplete="off">
                <button class="search-icon" id="search-btn">
                    <i class="fas fa-search"></i>
                </button>
            </div>
            <div id="search-results" class="search-results-container hidden"></div>
        </div>
    </div>

    <div class="category-section">
        <h2 class="cat-title">Danh Mục Sản Phẩm</h2>
        <div class="category-grid">
            {{ $sections := (.Site.GetPage "section" "san-pham").Sections }}
            {{ range $sections }}
            <a href="{{ .Permalink }}" class="cat-card">
                <div class="cat-img">
                    {{ $img := "" }}
                    {{ if in .Title "17" }}{{ $img = "/images/iphone-17-pro-max-titanium-orange.jpg" }}
                    {{ else if in .Title "16" }}{{ $img = "/images/iphone-16-pro-max-titanium-desert.jpg" }}
                    {{ else if in .Title "15" }}{{ $img = "/images/iphone-15-pro-max-titanium-natural.jpg" }}
                    {{ else if in .Title "14" }}{{ $img = "/images/iphone-14-pro-max-deep-purple.jpg" }}
                    {{ else if in .Title "13" }}{{ $img = "/images/iphone-13-pro-max-sierra-blue.jpg" }}
                    {{ else if in .Title "12" }}{{ $img = "/images/iphone-12-pro-pacific-blue.jpg" }}
                    {{ else }}{{ $img = "/images/feature_pp.png" }}{{ end }}
                    <img src="{{ $img }}" alt="{{ .Title }}">
                </div>
                <div class="cat-info"><h3>{{ .Title }}</h3></div>
            </a>
            {{ end }}
        </div>
    </div>

</div>

<script>
document.addEventListener("DOMContentLoaded", function() {
    let allProducts = [];
    const searchInput = document.getElementById("search-input");
    const resultsBox = document.getElementById("search-results");

    // 1. Tải dữ liệu sản phẩm
    fetch('/index.json')
        .then(r => r.json())
        .then(data => { allProducts = data; })
        .catch(e => console.error(e));

    // 2. Lắng nghe sự kiện gõ phím
    searchInput.addEventListener("input", function() {
        const keyword = this.value.trim().toLowerCase();
        
        // Nếu ô trống thì ẩn kết quả
        if(keyword.length === 0) {
            resultsBox.classList.add("hidden");
            return;
        }

        // Lọc sản phẩm
        const matches = allProducts.filter(p => p.title.toLowerCase().includes(keyword));
        
        // Hiển thị kết quả
        renderResults(matches);
    });

    // 3. Hàm vẽ kết quả
    function renderResults(products) {
        resultsBox.innerHTML = "";
        
        if(products.length === 0) {
            resultsBox.innerHTML = `<div class="search-no-results">Không tìm thấy sản phẩm nào.</div>`;
        } else {
            products.forEach(p => {
                // Format giá
                const price = new Intl.NumberFormat('vi-VN').format(p.lowestPrice) + ' đ';
                
                const item = document.createElement("a");
                item.href = p.url;
                item.classList.add("search-result-item");
                item.innerHTML = `
                    <img src="${p.image}" class="search-result-image" alt="${p.title}">
                    <div class="search-result-info">
                        <div class="search-result-title">${p.title}</div>
                        <div class="search-result-price">${price}</div>
                    </div>
                `;
                resultsBox.appendChild(item);
            });
        }
        resultsBox.classList.remove("hidden");
    }

    // 4. Ẩn kết quả khi click ra ngoài
    document.addEventListener("click", function(e) {
        if (!searchInput.contains(e.target) && !resultsBox.contains(e.target)) {
            resultsBox.classList.add("hidden");
        }
    });
});
</script>
{{ end }}